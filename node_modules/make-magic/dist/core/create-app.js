"use strict";var __awaiter=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(r,l){function i(e){try{s(o.next(e))}catch(e){l(e)}}function n(e){try{s(o.throw(e))}catch(e){l(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,n)}s((o=o.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createApp=void 0;const react_1=__importDefault(require("../compiled/react")),zombi_1=require("../compiled/zombi"),fs_1=__importDefault(require("fs")),url_1=require("url"),execa_1=__importDefault(require("../compiled/execa")),chalk_1=__importDefault(require("../compiled/chalk")),path_1=__importDefault(require("path")),repo_1=require("./utils/repo"),make_dir_1=require("./utils/make-dir"),config_1=require("./config"),path_helpers_1=require("./utils/path-helpers"),scaffold_helpers_1=require("./utils/scaffold-helpers"),filter_nil_values_1=require("./utils/filter-nil-values"),errors_warnings_1=require("./utils/errors-warnings"),flags_1=require("./flags"),shutdown_1=require("./utils/shutdown");function createApp(e){var t,a,o;return __awaiter(this,void 0,void 0,(function*(){const r=!!e.data,l=process.cwd(),i=fs_1.default.readdirSync(path_helpers_1.resolveToDist("scaffolds")).filter((e=>fs_1.default.statSync(path_helpers_1.resolveToDist("scaffolds",e)).isDirectory())).map((e=>({name:e,message:scaffold_helpers_1.getScaffoldDefinition(e).shortDescription,featured:scaffold_helpers_1.getScaffoldDefinition(e).featured}))),n=i.filter((e=>!!e.featured)).sort(((e,t)=>("boolean"==typeof e.featured?1/0:e.featured.order)-("boolean"==typeof t.featured?1/0:t.featured.order))),s=i.filter((e=>!e.featured)),c=i.map((e=>e.name)).includes(null==e?void 0:e.template);(null==e?void 0:e.template)&&!c&&(errors_warnings_1.printWarning(chalk_1.default`'{bold ${e.template}}' does not match any templates.`),console.warn());const d=react_1.default.createElement(zombi_1.Zombi,{name:"create-magic-app",templateRoot:!1,destinationRoot:l,data:filter_nil_values_1.filterNilValues({branch:null!==(t=null==e?void 0:e.branch)&&void 0!==t?t:"master",projectName:null==e?void 0:e.projectName,template:c?null==e?void 0:e.template:void 0}),prompts:[{type:"input",name:"projectName",message:"What is your project named?",initial:"my-app"},!c&&{type:"autocomplete",name:"template",message:"Choose a template:",choices:[...n,{role:"separator"},...s]}]},(t=>__awaiter(this,void 0,void 0,(function*(){const a=new url_1.URL(`${config_1.DEFAULT_CREATE_MAGIC_APP_REPO}/tree/${t.branch}`,config_1.GITHUB_BASE_URL),o=yield repo_1.getRepoInfo(a,path_helpers_1.getRelativeTemplatePath(t.template));if(o){const e=path_helpers_1.getAbsoluteTemplatePath(t.template);fs_1.default.existsSync(e)||(yield make_dir_1.makeDir(e),yield repo_1.downloadAndExtractRepo(e,o))}const r=yield flags_1.parseFlags(scaffold_helpers_1.getScaffoldDefinition(t.template).flags,null==e?void 0:e.data),l=scaffold_helpers_1.getScaffoldRender(filter_nil_values_1.filterNilValues(Object.assign(Object.assign(Object.assign({},e),r),t)));return react_1.default.createElement(zombi_1.Directory,{name:t.projectName},l())})))),u=yield zombi_1.scaffold(d),{projectName:p,template:f}=u.data["create-magic-app"];console.log();const _=process.cwd();process.chdir(p);const m=Object.assign(Object.assign({},u.data["create-magic-app"]),u.data[f]);if(r)yield null===(a=createPostRenderAction({data:m,cmd:"installDependenciesCommand"}))||void 0===a?void 0:a.wait();else{shutdown_1.addShutdownTask((()=>{console.log();const e=chalk_1.default`{rgb(92,101,246) M}{rgb(127,103,246) ag}{rgb(168,140,248) ic}`,t=["âœ¨\n",chalk_1.default`{bold {green Success!} You've bootstrapped a ${e} app with {rgb(0,255,255) ${f}}!}`,chalk_1.default`Created {bold.rgb(0,255,255) ${p}} at {bold.rgb(0,255,255) ${path_1.default.join(l,p)}}`];console.log(t.join("\n"))}));const e=yield null===(o=createPostRenderAction({data:m,cmd:"installDependenciesCommand",log:!0}))||void 0===o?void 0:o.wait(),t=createPostRenderAction({data:m,cmd:"startCommand",log:!0});shutdown_1.addShutdownTask((()=>{console.log();const a=[(e||t)&&chalk_1.default`Inside your app directory, you can run several commands:\n`,e&&chalk_1.default`  {rgb(0,255,255) ${e}}`,e&&chalk_1.default`    Install dependencies.\n`,t&&chalk_1.default`  {rgb(0,255,255) ${t}}`,t&&chalk_1.default`    Starts the app with a local development server.\n`,t&&chalk_1.default`Type the following to restart your newly-created app:\n`,t&&chalk_1.default`  {rgb(0,255,255) cd} ${p}`,t&&chalk_1.default`  {rgb(0,255,255) ${t}}`].filter(Boolean);console.log(a.join("\n"))})),yield null==t?void 0:t.wait()}return process.chdir(_),u}))}function printPostShutdownInstructions(e){console.log();const t=chalk_1.default`{rgb(92,101,246) M}{rgb(127,103,246) ag}{rgb(168,140,248) ic}`,a=[chalk_1.default`{bold You've successfully bootstrapped a ${t} app with {rgb(0,255,255) ${e.template}}!}`,chalk_1.default`Created {bold.rgb(0,255,255) ${e.projectName}} at {bold.rgb(0,255,255) ${path_1.default.join(e.destinationRoot,e.projectName)}}`];console.log(a.join("\n"))}function createPostRenderAction(e){const t=scaffold_helpers_1.getScaffoldDefinition(e.data.template)[e.cmd],a="function"==typeof t?t(e.data):null!=t?t:[],[o,...r]=a;if(o){const e=execa_1.default(o,r,{stdio:"inherit"}),t=a.join(" ");return Object.assign(t,{wait:()=>__awaiter(this,void 0,void 0,(function*(){return yield e,t}))})}}exports.createApp=createApp;